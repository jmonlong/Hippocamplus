<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Shell &middot; Hippocamplus
    
  </title>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113785126-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    
    gtag('config', "UA-113785126-1");
  </script>
  
  
  <link rel="stylesheet" href="../css/poole.css">
  <link rel="stylesheet" href="../css/syntax.css">
  <link rel="stylesheet" href="../css/lanyon.css">
  <link rel="stylesheet" href="../css/github.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="../fa/css/font-awesome.min.css">
  
  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/hippoPlus-icon.png">
  <link rel="shortcut icon" href="../assets/hippoPlus-icon.png">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="../atom.xml">
</head>

  
  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A place to gather useful information I keep on forgetting.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="../">Home</a>
    <a class="sidebar-nav-item " href="../post">Posts</a>

    
    
      
        <a class="sidebar-nav-item " href="../emacs/">Emacs</a>
      
    
      
        <a class="sidebar-nav-item " href="../expression/">Expression</a>
      
    
      
        <a class="sidebar-nav-item " href="../latex/">LaTeX</a>
      
    
      
        <a class="sidebar-nav-item " href="../markdown/">Markdown</a>
      
    
      
        <a class="sidebar-nav-item " href="../math/stats/">Math/Stats</a>
      
    
      
        <a class="sidebar-nav-item " href="../python/">Python</a>
      
    
      
        <a class="sidebar-nav-item " href="../r/">R</a>
      
    
      
        <a class="sidebar-nav-item  active " href="../shell/">Shell</a>
      
    
      
        <a class="sidebar-nav-item " href="../internet/">Internet</a>
      
    
      
        <a class="sidebar-nav-item " href="../about/">About</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
    
  </nav>

  <div class="sidebar-item">
  </div>
  
  <div class="sidebar-item">
    <div><a href="../index.xml"><i class="fa fa-rss-square" aria-hidden="true"></i> RSS</a></div>
    <div><a href="https://twitter.com/JMonlong"><i class="fa fa-twitter" aria-hidden="true"></i> @JMonlong</a></div>
    <p>&copy; 2019 Jean Monlong. All rights reserved.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="../" title="Home">Hippocamplus</a>
            <small>My Second Memory</small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="page">
  <h1 class="page-title">Shell</h1>
  

<div id="TOC">
<ul>
<li><a href="#git">Git</a></li>
<li><a href="#gnu-screen">GNU screen</a></li>
<li><a href="#misc">Misc</a><ul>
<li><a href="#colors-in-less">Colors in <code>less</code></a></li>
<li><a href="#avoid-killing-ssh-jobs">Avoid killing ssh jobs</a></li>
<li><a href="#rsync">rsync</a></li>
</ul></li>
<li><a href="#one-liners">One-liners</a><ul>
<li><a href="#bash-pipes">Bash &amp; Pipes</a></li>
<li><a href="#awk">AWK</a></li>
<li><a href="#perl-one-liners">Perl one-liners</a></li>
</ul></li>
<li><a href="#shell-scripting">Shell scripting</a><ul>
<li><a href="#variables">Variables</a></li>
<li><a href="#if-then-else">If Then Else</a></li>
</ul></li>
<li><a href="#convert-pdf">Convert PDF</a></li>
<li><a href="#docker-cheatsheet">Docker cheatsheet</a></li>
<li><a href="#makefile">Makefile</a></li>
<li><a href="#modules">Modules</a></li>
<li><a href="#osx">OSX</a><ul>
<li><a href="#mount-server">Mount server</a></li>
<li><a href="#setup-wd-elements-external-hard-drive">Setup WD Elements external hard drive</a></li>
</ul></li>
<li><a href="#ffmpeg">ffmpeg</a></li>
</ul>
</div>

<div id="git" class="section level2">
<h2>Git</h2>
<ul>
<li>Commit all modification and added files: <code>git commit -am &quot;informative message&quot;</code></li>
<li>To show all the history of a file: <code>git log -p -- file</code></li>
<li>To retrieve a specific version of a file: <code>git show COMMIT:file</code></li>
<li>Revert repo to a specific commit: <code>git checkout COMMIT</code></li>
<li>Undo a commit: <code>git reset HEAD~</code> and then for the real commit <code>git commit -c ORIG_HEAD</code>.</li>
<li>Update sub-modules: <code>git submodule update --init --recursive</code></li>
<li>Add all untracked files: <code>git st -s | grep '??' | cut -f2 -d ' ' | xargs git add</code></li>
<li>Add remote e.g. after a fork: <code>git remote add mine git@github.com:jmonlong/REPO.git</code></li>
</ul>
<div id="aliases" class="section level4">
<h4>Aliases</h4>
<pre class="sh"><code>git config --global alias.co checkout
git config --global alias.ci commit
git config --global alias.st status
git config --global alias.br branch
git config --global user.email &#39;&lt;EMAIL&gt;&#39;
git config --global user.name &#39;Jean Monlong&#39;</code></pre>
</div>
<div id="branches" class="section level4">
<h4>Branches</h4>
<ul>
<li>List branches: <code>git branch</code></li>
<li>List all branches: <code>git branch -a</code></li>
<li>Update remote branch list: <code>git remote prune origin</code></li>
<li>Create branch: <code>git checkout -b hotfix</code></li>
<li>Link it to a remote branch: <code>git branch -u origin/hotflix</code></li>
<li>Creat a new local branch from remote: <code>git co -t origin/hotfix</code></li>
<li>Merge the current branch with another branch: <code>git merge hotfix</code></li>
<li>Delete a branch: <code>git branch -d hotfix</code></li>
<li>Delete remote branch: <code>git push origin :hotfix</code></li>
</ul>
</div>
<div id="check-status-of-all-repos" class="section level4">
<h4>Check status of all repos</h4>
<p>I have an alias calling the following commands:</p>
<pre class="sh"><code>WD=`pwd`
for ff in `find . -maxdepth 5 -name .git`
do
    GDIR=`dirname $ff`
    echo $GDIR
    cd $WD/$GDIR
    git st -s
    git st | grep ahead
done
cd $WD</code></pre>
</div>
</div>
<div id="gnu-screen" class="section level2">
<h2>GNU screen</h2>
<p>I had the following problems in some HPCs:</p>
<ul>
<li>screen not clearing out after commands like <em>less</em> or <em>emacs</em>.</li>
<li><em>Ctl-l</em> not clearing out the screen.</li>
<li>Emacs rendering badly with annoying visual glitches. I had to constantly <em>Ctl-L</em> to clean them.</li>
</ul>
<p>The solution was to add in <code>~/.screenrc</code>:</p>
<pre class="sh"><code># clear out screen after less etc
altscreen on
# fixes ctr-l and emacs visual glitches
term screen-256color</code></pre>
</div>
<div id="misc" class="section level2">
<h2>Misc</h2>
<ul>
<li>Redirect stderr to stdout: <code>2&gt;&amp;1</code>.</li>
<li>Show special characters (end of line, tabs) with <code>cat -A</code>.</li>
</ul>
<div id="colors-in-less" class="section level3">
<h3>Colors in <code>less</code></h3>
<p>Use the <code>-r</code> or <code>-R</code> option. Sometimes the previous command needs a parameter make sure the output includes color codes.</p>
<pre class="sh"><code>tree -C | less -R
ls --color | less -R
grep --color=always | less -R</code></pre>
</div>
<div id="avoid-killing-ssh-jobs" class="section level3">
<h3>Avoid killing ssh jobs</h3>
<p><code>nohup</code> function (apparently).</p>
</div>
<div id="rsync" class="section level3">
<h3>rsync</h3>
<p><code>rsync</code> is not completely intuitive to me. Here are some of the commands I could make work.</p>
<hr />
<p>To recurrently sync all the files that match the patterns in <code>rsyncIncludes.txt</code>:</p>
<pre class="sh"><code>rsync -r --include=&#39;*/&#39; --include-from=rsyncIncludes.txt --exclude=&#39;*&#39; --prune-empty-dirs SRC DEST</code></pre>
<hr />
<p>To recurrently sync all the files that match the patterns in <code>rsyncIncludes.txt</code> EXCEPT some with a specific pattern. Practical example: all the R scripts but not the ones created by BatchJobs in <code>*-files</code> directories:</p>
<pre class="sh"><code>rsync -r --exclude=&quot;*-files&quot; --include=&#39;*/&#39; --include=&#39;*.R&#39; --exclude=&#39;*&#39; --prune-empty-dirs SRC DEST</code></pre>
</div>
</div>
<div id="one-liners" class="section level2">
<h2>One-liners</h2>
<div id="bash-pipes" class="section level3">
<h3>Bash &amp; Pipes</h3>
<p>Add headers with cat</p>
<pre><code>cat file.txt | cat headers.txt -</code></pre>
<hr />
<p>Remove empty directories</p>
<pre><code>find . -type d | xargs rmdir</code></pre>
<hr />
<p>Git add all untracked files</p>
<pre><code>git st -s | grep &#39;??&#39; | cut -f2 -d &#39; &#39; | xargs git add</code></pre>
</div>
<div id="awk" class="section level3">
<h3>AWK</h3>
<ul>
<li>Capture group in string regexp using <code>match($0, /xxx(.*)yyy/, a); print a[1]'</code></li>
</ul>
</div>
<div id="perl-one-liners" class="section level3">
<h3>Perl one-liners</h3>
<p>Inspired from these: <a href="http://www.catonmat.net/blog/introduction-to-perl-one-liners/">Catonmat</a>, <a href="https://blogs.oracle.com/ksplice/the-top-10-tricks-of-perl-one-liners">Ksplice</a></p>
<ul>
<li><code>-p</code> run command on each line and print line.</li>
<li><code>-n</code> run command on each line but don’t print line.</li>
<li><code>-i</code> operates on the file in-place, i.e. updating the input file.</li>
<li><code>-a</code> split the lines by white spaces into a <code>@F</code> array (<code>-F</code> to choose the separator)</li>
<li><code>-l</code> removes the trailing new line, and adds it back if <code>-p</code> is used.</li>
<li><code>$_</code> contains the line.</li>
<li><p><code>$.</code> contains the line number.</p></li>
<li>Replace text line-by-line in a file: <code>perl -pe 's/you/me/g'</code></li>
<li>Replace text if line contains <em>foo</em>: <code>perl -pe 's/you/me/g if /foo/</code></li>
<li>Replace text line-by-line with regexp: <code>perl -pe 's/ID(\d+)/$1/g'</code></li>
<li>Operations on a CSV file: <code>perl -F, -ane 'print $F[3]+$F[8]</code></li>
<li>Operations on a CSV file and print at the end: <code>perl -F, -ane $t+=$F[3]+$F[8]; END{print $t}</code> %</li>
<li><p>Print matches from regular expression: <code>perl -ne 'print &quot;$1\n&quot; if /foo=([^;]*)/'</code></p></li>
</ul>
</div>
</div>
<div id="shell-scripting" class="section level2">
<h2>Shell scripting</h2>
<p>Start a script with one of the <a href="https://en.wikipedia.org/wiki/Shebang_%28Unix%29">shebang</a></p>
<pre class="sh"><code>#!/bin/sh</code></pre>
<div id="variables" class="section level3">
<h3>Variables</h3>
<p>To remove a specific prefix/suffix from a variable name:</p>
<pre class="sh"><code>foo=${foop#$prefix}
foo=${foos%$suffix}</code></pre>
</div>
<div id="if-then-else" class="section level3">
<h3>If Then Else</h3>
<p>A simple example:</p>
<pre class="sh"><code>if [ $VAL == &quot;YEP&quot; ]; then
    echo &quot;It&#39;s a yes!&quot;
else
    echo &quot;No no no :(&quot;
fi</code></pre>
<p>Or with multiple conditions:</p>
<pre class="sh"><code>if [ $VAL == &quot;YEP&quot; ] &amp;&amp; [ COND ]; then
    echo &quot;It&#39;s a yes!&quot;
else
    echo &quot;No no no :(&quot;
fi</code></pre>
<p>The spacing is quite important, and the conditions can be built with:</p>
<ul>
<li><code>-eq</code> equal to.</li>
<li><code>-ne</code> not equal to.</li>
<li><code>-lt</code> less than.</li>
<li><code>-le</code> less or equal than.</li>
<li><code>-gt</code> great than.</li>
<li><code>-ge</code> great or equal than.</li>
<li><code>-s</code> file exists and not empty.</li>
<li><code>-f</code> file exists and not directory.</li>
<li><code>-d</code> directory exists.</li>
<li><code>-x</code> file executable.</li>
<li><code>-w</code> file writable.</li>
<li><code>-r</code> file readable.</li>
</ul>
</div>
</div>
<div id="convert-pdf" class="section level2">
<h2>Convert PDF</h2>
<div id="to-eps" class="section level4">
<h4>to EPS</h4>
<p>I ended up using Inkscape in command-line mode. The result is not so bad (better than the <code>pdf2eps</code> etc).</p>
<pre class="sh"><code>inkscape document.pdf --export-eps=document.eps</code></pre>
<p><a href="http://blm.io/blog/convert-pdf-eps-osx/">Apparently</a>, <code>pdftops</code> is even better.</p>
<pre class="sh"><code>pdftops -eps document.pdf</code></pre>
</div>
<div id="to-pdfa" class="section level4">
<h4>to PDF/A</h4>
<p>In the end I had to use Acrobat Reader Pro… Still, converting the PDF using the following commands beforehand helped (otherwise Acrobat Reader Pro couldn’t convert it):</p>
<pre class="sh"><code>gs -dPDFA=1 -dBATCH -dNOPAUSE -dEmbedAllFonts=true -dSubsetFonts=false -dHaveTrueTypes=true -dPDFSETTINGS=/prepress -sProcessColorModel=DeviceRGB -sDEVICE=pdfwrite -sPDFACompatibilityPolicy=1 -sOutputFile=mainPDFA.pdf main.pdf</code></pre>
<p>On the other hand, passing by a <code>.ps</code> stage as recommended <a href="https://superuser.com/questions/188953/how-to-convert-a-pdf-to-a-pdf-a">here</a>, produced a smaller PDF that was directly PDF/A compliant (no need for Acrobat Reader Pro) but lost all cross-reference links :(</p>
<pre class="sh"><code>pdftops main.pdf main.ps
gs -dPDFA -dBATCH -dNOPAUSE -dNOOUTERSAVE -dUseCIEColor -sProcessColorModel=DeviceCMYK -sDEVICE=pdfwrite -sPDFACompatibilityPolicy=1 -sOutputFile=mainPDFA.pdf main.ps</code></pre>
<p>To check for PDF/A compliance I used <a href="https://www.pdf-online.com/osa/validate.aspx">this online validator</a> or Acrobat Reader Pro. Another way to check for problems is to look at the <em>emb</em> column of <code>pdffonts main.pdf</code> (should be all embedded) and the <em>type</em> column of <code>pdfimages -list main.pdf</code> (should be all <em>image</em>).</p>
<p><em>Note: this is based only on my one-time experience with the PDF of my thesis.</em></p>
</div>
</div>
<div id="docker-cheatsheet" class="section level2">
<h2>Docker cheatsheet</h2>
<p>I’m still learning Docker but here are commands/parameters that seem relevant for me:</p>
<div id="build-a-docker-instance" class="section level4">
<h4>Build a docker instance</h4>
<p><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Write a Dockerfile</a> :</p>
<ul>
<li><code>WORKDIR /root</code> sets the working directory.</li>
<li><code>COPY PopSV_1.0.tar.gz ./</code> copies a file in the instance. The <code>/</code> is important !</li>
<li>There is a cache management system so it’s important to keep related commands in the same <code>RUN</code>.</li>
</ul>
<p>To run in the folder with the <code>Dockerfile</code>.</p>
<pre class="sh"><code>docker build -t jmonlong/popsv-docker .</code></pre>
</div>
<div id="launch-a-docker-instance" class="section level4">
<h4>Launch a docker instance</h4>
<p>To launch an interactive instance with a shared folder:</p>
<pre class="sh"><code>docker run -t -i -v /home/ubuntu/analysis1:/root/analysis1 jmonlong/popsv-docker</code></pre>
<ul>
<li><code>-t</code> and <code>-i</code> are used for interactive run.</li>
<li><code>-v</code> links folder in the host with folder in the image. It must be **absolute paths*.</li>
</ul>
</div>
<div id="increase-memory" class="section level4">
<h4>Increase memory</h4>
<p>In Mac OS, I had some problems with the docker stopping because of memory issues. I fixed by changing:</p>
<pre class="sh"><code>docker-machine stop
VBoxManage modifyvm default --cpus 3
VBoxManage modifyvm default --memory 8192
docker-machine start</code></pre>
</div>
</div>
<div id="makefile" class="section level2">
<h2>Makefile</h2>
<ul>
<li><a href="https://gist.github.com/isaacs/62a2d1825d04437c6f08">Makefile basics from Isaacs</a>.</li>
</ul>
</div>
<div id="modules" class="section level2">
<h2>Modules</h2>
<p>For example installing Emacs as a module on a HPC. After installing Emacs locally in a <code>~/softwares/emacs/emacs-24.4</code> I create a file <code>~/myModules/jmonlong/emacs/24.4</code> with:</p>
<pre class="shell"><code>#%Module1.0
proc ModulesHelp { } {
  puts stderr &quot;\tMUMmer &quot;
}
module-whatis &quot;mummer&quot;

set             root                /home/jmonlong/softwares/emacs/emacs-24.4
prepend-path    PATH                $root/bin
prepend-path    LIBRARY_PATH        $root/lib/
prepend-path    LD_LIBRARY_PATH     $root/lib/</code></pre>
<p>Then to use the module:</p>
<pre class="shell"><code>module use ~/myModules
module load jmonlong/emacs</code></pre>
</div>
<div id="osx" class="section level2">
<h2>OSX</h2>
<div id="mount-server" class="section level3">
<h3>Mount server</h3>
<p>I created a directory <code>sftp</code> (I don’t know why I choose this name…anyway) and mount the root of the different servers there. Eventually I created a symbolic link at the root of my computer to point there so that paths like <code>/gs/projects/...</code> work directly, as if in the cluster.</p>
<p>To mount a server I use the following command:</p>
<pre class="sh"><code>sshfs jmonlong@guillimin.hpc.mcgill.ca:/ /Users/jeanmonlong/sftp/guillimin -ovolname=NAME</code></pre>
</div>
<div id="setup-wd-elements-external-hard-drive" class="section level3">
<h3>Setup WD Elements external hard drive</h3>
<p>By default the disk is formatted in NTFS, which OSX could read only. To write, the solution that worked for me was to add this line to <code>/etc/fstab</code>:</p>
<pre class="sh"><code>LABEL=Elements none ntfs rw,auto,nobrowse</code></pre>
<p><em>Note: If there are spaces in the label, replace them by <code>\040</code>.</em></p>
<p>The disk can then be accessed through the <em>Volumes</em> folder (<code>/Volumes</code>).</p>
</div>
</div>
<div id="ffmpeg" class="section level2">
<h2>ffmpeg</h2>
<p>To convert to MP3: <code>ffmpeg -i my.m4a -acodec mp3 -ac 2 -ab 192k my.mp3</code></p>
</div>

</div>

      </div>
    </div>

    
    

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src="../assets/highlight.min.js"></script>
    <script src="../assets/r.min.js"></script>
    
    <script>
      hljs.configure({languages: ['r']});
      hljs.initHighlightingOnLoad();
    </script>

    <script src="//yihui.name/js/math-code.js"></script>
    <script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    
  </body>
</html>

