---
sidebar: true
title: Tools
weight: 1
output:
  blogdown::html_page:
    toc: true
---


<div id="TOC">
<ul>
<li><a href="#git" id="toc-git">Git</a></li>
<li><a href="#snakemake" id="toc-snakemake">Snakemake</a></li>
<li><a href="#bcftools" id="toc-bcftools">bcftools</a></li>
<li><a href="#jq" id="toc-jq">jq</a></li>
<li><a href="#vd" id="toc-vd">vd</a></li>
<li><a href="#rsync" id="toc-rsync">rsync</a></li>
<li><a href="#docker" id="toc-docker">Docker</a></li>
<li><a href="#wdl" id="toc-wdl">WDL</a></li>
<li><a href="#makefile" id="toc-makefile">Makefile</a></li>
<li><a href="#ftp" id="toc-ftp">FTP</a></li>
<li><a href="#thunderbird" id="toc-thunderbird">Thunderbird</a></li>
<li><a href="#for-file-conversion" id="toc-for-file-conversion">For file conversion</a>
<ul>
<li><a href="#misc" id="toc-misc">Misc</a></li>
<li><a href="#video-conversion-with-ffmpeg" id="toc-video-conversion-with-ffmpeg">Video conversion with ffmpeg</a></li>
<li><a href="#pdf" id="toc-pdf">PDF</a></li>
</ul></li>
</ul>
</div>

<div id="git" class="section level2">
<h2>Git</h2>
<ul>
<li>Commit all modification and added files: <code>git commit -am "informative message"</code></li>
<li>To show all the history of a file: <code>git log -p -- file</code></li>
<li>To retrieve a specific version of a file: <code>git show COMMIT:file</code></li>
<li>Revert repo to a specific commit: <code>git checkout COMMIT</code></li>
<li>Undo a commit: <code>git reset HEAD~</code> and then for the real commit <code>git commit -c ORIG_HEAD</code>.</li>
<li>Add all untracked files: <code>git st -s | grep '??' | cut -f2 -d ' ' | xargs git add</code></li>
<li>Unstage a file (without reverting its potential changes): <code>git restore --staged FILE</code></li>
<li>Unstage all files <code>git reset</code></li>
<li>Add remote e.g. after a fork: <code>git remote add mine git@github.com:jmonlong/REPO.git</code></li>
<li>Activate credential saving (avoid retyping username/passwords, e.g. when SSH keys don’t work): <code>git config credential.helper store</code></li>
</ul>
<div id="aliases" class="section level4">
<h4>Aliases</h4>
<pre class="sh"><code>git config --global alias.co checkout
git config --global alias.ci commit
git config --global alias.st status
git config --global alias.br branch
git config --global user.email &#39;&lt;EMAIL&gt;&#39;
git config --global user.name &#39;Jean Monlong&#39;</code></pre>
</div>
<div id="branches" class="section level4">
<h4>Branches</h4>
<ul>
<li>List branches: <code>git branch</code></li>
<li>List all branches: <code>git branch -a</code></li>
<li>Update remote branch list: <code>git remote prune origin</code></li>
<li>Create branch: <code>git checkout -b hotfix</code></li>
<li>Link it to a remote branch: <code>git branch -u origin/hotflix</code></li>
<li>Creat a new local branch from remote: <code>git co -t origin/hotfix</code></li>
<li>Merge the current branch with another branch: <code>git merge hotfix</code></li>
<li>Delete a branch: <code>git branch -d hotfix</code></li>
<li>Delete remote branch: <code>git push origin :hotfix</code></li>
</ul>
</div>
<div id="tags" class="section level4">
<h4>Tags</h4>
<p>Create a tag:</p>
<pre class="sh"><code>git tag -a tagname -m &quot;message&quot;</code></pre>
<hr />
<p>Push tag:</p>
<pre class="sh"><code>git push --tags</code></pre>
</div>
<div id="submodules" class="section level4">
<h4>Submodules</h4>
<ul>
<li><a href="https://devconnected.com/how-to-add-and-update-git-submodules/">How-To at devconnected.com</a></li>
<li>Clone a repo with submodules: <code>git clone --recursive https://github.com/XXX/XXX.git</code></li>
<li>Update sub-modules: <code>git submodule update --init --recursive</code></li>
</ul>
<p>Fetch new submodule commits:</p>
<pre><code>## in the submodule
git fetch
git checkout &lt;COMMIT&gt;
## in the main repo
git add .
git commit -m &quot;updated the submodule&quot;
git push</code></pre>
</div>
<div id="check-status-of-all-repos" class="section level4">
<h4>Check status of all repos</h4>
<p>I have an alias calling the following commands:</p>
<pre class="sh"><code>WD=`pwd`
for ff in `find . -maxdepth 5 -name .git`
do
    GDIR=`dirname $ff`
    echo $GDIR
    cd $WD/$GDIR
    git st -s
    git st | grep ahead
done
cd $WD</code></pre>
</div>
</div>
<div id="snakemake" class="section level2">
<h2>Snakemake</h2>
<ul>
<li><a href="https://snakemake.readthedocs.io">Documentation</a></li>
</ul>
<p>A few trick I’d like to remember or try soon:</p>
<ul>
<li>Double “{{”/“}}” to escape <code>{</code> <code>}</code> in <em>expand</em> or NOT to define wildcards.</li>
<li>Define regexp constraints on wildcards as <code>{data,\d+}</code> or using <em>wildcard_constraints</em> (within a rule or globally).</li>
<li>Passing a Python/R <em>script:</em> directly.</li>
<li>Output file marked as <code>temp()</code> are deleted when not needed by any rules anymore.</li>
<li>Output file marked as <code>touch()</code> for flag files.</li>
<li>Local rules when running on a HPC.</li>
<li>Use remote (S3) files with <code>remote()</code></li>
</ul>
<p><a href="https://snakemake.readthedocs.io/en/stable/snakefiles/configuration.html#configuration">Configuration files</a> used as <code>config["samples"]</code>.
Can also be used as <code>snakemake --config yourparam=1.5</code>.
For sample metadata, a <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/configuration.html#tabular-configuration">tabular configuration</a> can also be used using Pandas.
It’s also possible to define a separate config file for the cluster configuration (e.g. resources for each rule).</p>
<p>To use more flexible inputs, use a function and <code>unpack</code>:</p>
<pre class="python"><code>def input_func(wildcards):
    return {&#39;file1&#39;: &#39;{wildcards.val}.txt&#39;.format(wildcards=wildcards)}
rule myrule:
    input:
        unpack(input_func)
    output:
        &quot;output.{val}.txt&quot;
    shell: &quot; ... {input.file1} ...&quot;</code></pre>
</div>
<div id="bcftools" class="section level2">
<h2>bcftools</h2>
<ul>
<li><a href="https://samtools.github.io/bcftools/bcftools.html">bcftools man page</a></li>
<li><a href="https://samtools.github.io/bcftools/howtos/index.html">bcftools tutorials</a></li>
</ul>
<div id="rename-sample" class="section level4">
<h4>Rename sample</h4>
<pre><code>echo SAMPLENAME &gt; temp.txt
bcftools reheader -s temp.txt input.vcf.gz &gt; output.vcf.gz</code></pre>
</div>
<div id="remove-info-fields-and-keep-gt-only" class="section level4">
<h4>Remove INFO fields and keep GT only</h4>
<pre><code>bcftools annotate -x INFO,^FORMAT/GT input.vcf.gz</code></pre>
</div>
<div id="extract-a-sample-and-keep-only-sites-with-an-alt-allele" class="section level4">
<h4>Extract a sample and keep only sites with an alt allele</h4>
<pre><code>bcftools view -c 1 -s SAMPLENAME input.vcf.gz</code></pre>
</div>
<div id="add-anacaf-to-the-info" class="section level4">
<h4>Add AN,AC,AF to the INFO</h4>
<pre><code>bcftools +fill-tags input.vcf.gz -Oz -o output.vcf.gz --threads 4 -- -t AN,AC,AF</code></pre>
</div>
<div id="filter-by-allele-size" class="section level4">
<h4>Filter by allele size</h4>
<pre><code>bcftools view -i &quot;STRLEN(REF)&lt;30 &amp; MAX(STRLEN(ALT))&lt;30&quot; input.vcf</code></pre>
</div>
</div>
<div id="jq" class="section level2">
<h2>jq</h2>
<p><a href="https://programminghistorian.org/en/lessons/json-and-jq">Lesson at programminghistorian.org</a></p>
<ul>
<li>Select elements based on one field’s value: <code>jq 'select(.field==value)'</code></li>
<li>Keep only desired fields: <code>jq '{id: .id, title: .title}'</code></li>
<li>Write in TSV: <code>jq '.array | @tsv'</code></li>
</ul>
</div>
<div id="vd" class="section level2">
<h2>vd</h2>
<p><a href="https://github.com/saulpw/visidata">vd</a> can read many file formats, including TSV, CSV, JSON.
I use it to explore TSV files as a more powerful <em>less</em>.
It’s great to format wide columns but also to quickly explore summary stats of the table.</p>
<p>Keybindings:</p>
<ul>
<li><code>Ctr-H</code> or <code>z?</code> triggers the help page</li>
<li><code>_</code> expand/contract column.</li>
<li><code>z_ &lt;N&gt;</code> set current column width to <em>N</em>.</li>
<li><code>/</code> regex search in current column</li>
<li><code>g/</code> regex search in all columns</li>
<li><code>n</code>/<code>N</code> move to next/previous match</li>
<li><code>[</code>/<code>]</code> sort ascending/descending by current column</li>
<li>Select rows and filter:
<ul>
<li><code>|</code> select by regexp in current column</li>
<li><code>,</code> select rows matching current cell in current column</li>
<li><code>z|</code> select by Python expression</li>
<li><code>z"</code> copy selected rows to new sheet</li>
</ul></li>
<li><code>F</code> toggle a frequency table/histogram of the current column.
<ul>
<li><code>Enter</code> to focus on a subset defined by a row in frequency table.</li>
<li>Enable binning of the values (and decide the bin size) in the Options sheet (<code>O</code>)</li>
</ul></li>
<li><code>I</code> toggle Describe sheet with summary statistics for each column.</li>
<li><code>.</code> toggle dot plot.
<ul>
<li>Make sure to set a column as numeric with <code>#</code>.</li>
<li>Eventually select x-axis or labels with <code>!</code> first.</li>
</ul></li>
</ul>
<p>To keep the same color palette/theme as my terminal, I set the theme to <code>asciimono</code> in my <code>~/.visidatarc</code> (see <a href="https://jsvine.github.io/intro-to-visidata/advanced/configuring-visidata/#the-visidatarc-file">manual</a>):</p>
<pre class="txt"><code>options.theme = &quot;asciimono&quot;</code></pre>
</div>
<div id="rsync" class="section level2">
<h2>rsync</h2>
<p><code>rsync</code> is not completely intuitive to me.
Here are some of the commands I could make work.</p>
<hr />
<p>To recurrently sync all the files that match the patterns in <code>rsyncIncludes.txt</code>:</p>
<pre class="sh"><code>rsync -r --include=&#39;*/&#39; --include-from=rsyncIncludes.txt --exclude=&#39;*&#39; --prune-empty-dirs SRC DEST</code></pre>
<hr />
<p>To recurrently sync all the files that match the patterns in <code>rsyncIncludes.txt</code> EXCEPT some with a specific pattern.
Practical example: all the R scripts but not the ones created by BatchJobs in <code>*-files</code> directories:</p>
<pre class="sh"><code>rsync -r --exclude=&quot;*-files&quot; --include=&#39;*/&#39; --include=&#39;*.R&#39; --exclude=&#39;*&#39; --prune-empty-dirs SRC DEST</code></pre>
</div>
<div id="docker" class="section level2">
<h2>Docker</h2>
<div id="build-a-docker-instance" class="section level4">
<h4>Build a docker instance</h4>
<p><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Write a Dockerfile</a> :</p>
<ul>
<li><code>WORKDIR /root</code> sets the working directory.</li>
<li><code>COPY PopSV_1.0.tar.gz ./</code> copies a file in the instance. The <code>/</code> is important !</li>
<li>There is a cache management system so it’s important to keep related commands in the same <code>RUN</code>.</li>
</ul>
<p>To run in the folder with the <code>Dockerfile</code>.</p>
<pre class="sh"><code>docker build -t jmonlong/popsv-docker .</code></pre>
<p>Ignore (big) files fro the build context using a <code>.dockerignore</code> file.</p>
<p>To make setup a time zone for a ubuntu-based container, use <em>tzdata</em> in the Dockerfile:</p>
<pre class="docker"><code>RUN apt-get -y update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install tzdata
ENV TZ=America/Los_Angeles</code></pre>
<p>The time zone can also be changed in run command using <code>-e TZ=America/Los_Angeles</code>.
<a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">List of time zone codes</a></p>
<p>To build smaller images, use less layers and a smaller base image (e.g. <a href="https://www.docker.com/blog/how-to-use-the-alpine-docker-official-image/">Alpine images</a>).</p>
</div>
<div id="launch-a-docker-instance" class="section level4">
<h4>Launch a docker instance</h4>
<p>To launch an interactive instance with a shared folder:</p>
<pre class="sh"><code>docker run -t -i -v /home/ubuntu/analysis1:/root/analysis1 jmonlong/popsv-docker</code></pre>
<ul>
<li><code>-t</code> and <code>-i</code> are used for interactive run.</li>
<li><code>-v</code> links folder in the host with folder in the image. It must be <strong>absolute paths</strong>.</li>
<li>Sometimes use <code>bash</code> as the command to force interactive, or <code>--entrypoint /bin/bash</code> if the image uses an <em>ENTRYPOINT</em>.</li>
<li>To make sure the files created by the container have the appropriate owner use: <code>-u `id -u $USER`</code>.</li>
</ul>
</div>
<div id="increase-memory" class="section level4">
<h4>Increase memory</h4>
<p>In Mac OS, I had some problems with the docker stopping because of memory issues.
I fixed by changing:</p>
<pre class="sh"><code>docker-machine stop
VBoxManage modifyvm default --cpus 3
VBoxManage modifyvm default --memory 8192
docker-machine start</code></pre>
</div>
<div id="clean-up-space" class="section level4">
<h4>Clean up space</h4>
<p>To remove all images:</p>
<pre class="sh"><code>docker rm -vf $(docker ps -a -q)
docker rmi -f $(docker images -a -q)</code></pre>
<p>To clean cache too:</p>
<pre class="sh"><code>docker system prune -a</code></pre>
</div>
</div>
<div id="wdl" class="section level2">
<h2>WDL</h2>
<p>A few useful commands/trick/remainders for WDL (see <a href="https://github.com/openwdl/wdl/blob/main/versions/1.0/SPEC.md">full specs</a>).</p>
<ul>
<li><code>size(file_name, 'G')</code> to get the size in Gb (e.g. for dynamic disk space allocation). Used with <code>ceil</code>/<code>round</code> to get a round number.</li>
<li>and=<code>&amp;&amp;</code>, or=<code>||</code></li>
<li><code>~{true="yes" false="no" boolean_value}</code> to inject different strings in the command section, depending on the value of a Boolean.</li>
<li><code>~{sep="," array_value}</code> to “join” an array into a string.</li>
<li><code>Int value = if othervalue &lt; 5 then 1 else 4</code></li>
<li><code>glob("*.bam")</code> to cath output files for example.</li>
<li><code>String out_prefix = basename(in_gam_file, ".gam")</code> to get the basename of a file and strip a suffix too.</li>
<li><code>String out_prefix = sub(sub(sub(basename(in_gam_file), "\\.gz$", ""), "\\.gaf$", ""), "\\.gam$", "")</code> another way for when the extension is variable.</li>
<li><code>File sel_file = select_first([OPTIONAL_INPUT_FILE, task.output_file])</code> to select the first defined arg in an array (e.g. when a task can recreate an optional input).</li>
<li><code>flatten([array1, [new_element]])</code> to add <em>new_element</em> to an existing <em>array1</em>.</li>
<li><code>Array[Pair[File,File]] paired_files_list = zip(file_list_1, file_list_2)</code>, e.g. to scatter across two lists. In the scatter, access with <code>.left</code>/<code>.right</code>.</li>
<li>Start command section with <code>set -eux -o pipefail</code> to stop the job at the first error, even in a pipe.</li>
<li><a href="https://github.com/jmonlong/wdl-workflows/blob/master/read_stats/workflow.wdl">Simple workflow with typical structure</a></li>
</ul>
<p>If an input is a (long) array, use it through a file with one element per line (see in <a href="https://github.com/openwdl/wdl/blob/main/versions/1.0/SPEC.md#array-serialization-using-write_lines">WDL Spec</a>):</p>
<pre><code>input {
    Array[File] in_vcf_list
}
command &lt;&lt;&lt;
while read invcf
do
    command $invcf
done &lt; ~{write_lines(in_vcf_list)}
## or
command -f ~{write_lines(in_vcf_list)}
&gt;&gt;&gt;</code></pre>
</div>
<div id="makefile" class="section level2">
<h2>Makefile</h2>
<ul>
<li><p><a href="https://www.gnu.org/software/make/manual/html_node/index.html">GNU make manual</a></p></li>
<li><p><a href="https://gist.github.com/isaacs/62a2d1825d04437c6f08">Makefile basics from Isaacs</a>.</p></li>
<li><p><a href="https://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html#Automatic-Variables">Automatic variables</a></p>
<ul>
<li><code>$@</code> the target</li>
<li><code>$&lt;</code> the first prerequisite</li>
<li><code>$^</code> all prerequisites</li>
<li><code>$(@D)</code> the directory part of <code>$@</code> (works the same with <code>&lt;</code>,<code>^</code>, etc).</li>
<li><code>$(@F)</code> the filename part of <code>$@</code> (works the same with <code>&lt;</code>,<code>^</code>, etc).</li>
</ul></li>
<li><p><a href="https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html#File-Name-Functions">File name functions</a></p>
<ul>
<li><code>$(notdir src/foo.c)</code> returns <em>foo.c</em>.</li>
<li><code>$(addsuffix .c,foo)</code> returns <em>foo.c</em>.</li>
<li><code>$(basename dir/foo.test.c)</code> returns <em>dir/foo.test</em>.</li>
<li><code>objects := $(wildcard *.o)</code> to list files in a variable.</li>
</ul></li>
<li><p><a href="https://www.gnu.org/software/make/manual/html_node/Text-Functions.html#Text-Functions">String functions</a></p>
<ul>
<li><code>$(patsubst %.c,%.o,file.c)</code> to substitute file extensions</li>
<li><code>$(subst from,to,text)</code> replaces all occurrences of <em>from</em> to <em>to</em> in <em>text</em>.</li>
<li><code>$(word n,text)</code> returns the n-th word in <em>text</em>.</li>
</ul></li>
<li><p>Shell function: <code>$(shell cat foo)</code> runs a shell command.</p></li>
</ul>
</div>
<div id="ftp" class="section level2">
<h2>FTP</h2>
<p>Basic commands:</p>
<ul>
<li><code>cd</code>/<code>ls</code> to change directory/list files in the remote location</li>
<li><code>get</code> to copy a file from the remote location to the local machine</li>
<li><code>put</code> to copy a file from the local machine to the remote location</li>
<li><code>delete</code> to remove a file in the remote location</li>
<li><code>lcd</code> to change directory in the local machine</li>
<li><code>help</code> to list FTP commands</li>
</ul>
</div>
<div id="thunderbird" class="section level2">
<h2>Thunderbird</h2>
<ul>
<li>Force a better date format: <code>Settings</code>, <code>General</code>, <code>Config Editor</code> (at the bottom), Set <em>intl.date_time.pattern_override.date_short</em> to a string <code>yyyy-MM-dd</code>.</li>
<li>Langtool extension for spell checking.</li>
<li>Shorcuts
<ul>
<li>Archive message: <code>A</code></li>
<li>New message: <code>Ctrl+N</code></li>
<li>Add attachment: <code>Ctrl+Shift+A</code></li>
<li>Send message: <code>Ctrl+Enter</code></li>
<li>Reply: <code>Ctrl+R</code> or <code>Ctrl+Shift+R</code></li>
<li>Forward: <code>Ctrl+L</code></li>
<li>Expand/collapse threads: <code>Left</code>/<code>Right</code></li>
<li>Search all message: <code>Ctrl+K</code></li>
<li>Advanced search: <code>Ctrl+Shift+F</code></li>
<li>Go to previous/next message: <code>B</code>/<code>F</code></li>
</ul></li>
</ul>
</div>
<div id="for-file-conversion" class="section level2">
<h2>For file conversion</h2>
<div id="misc" class="section level3">
<h3>Misc</h3>
<ul>
<li>SVG to PDF: <code>inkscape --file=in.svg --export-area-drawing --without-gui --export-pdf=out.pdf</code></li>
<li>HTML page to PDF: <code>pandoc -o out.pdf --include-in-header h.tex URL</code> where <em>h.tex</em> could contain LaTeX packages declarations like <code>\usepackage{fullpage}</code>.</li>
<li>Docx to PDF: <code>pandoc -o out.pdf --pdf-engine=weasyprint in.docx</code> with <a href="https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation">WeasyPrint (installable through <code>pip</code></a></li>
</ul>
</div>
<div id="video-conversion-with-ffmpeg" class="section level3">
<h3>Video conversion with ffmpeg</h3>
<div id="video-to-mp3" class="section level5">
<h5>Video to mp3:</h5>
<pre><code>ffmpeg -i in.m4a -acodec mp3 -ac 2 -ab 192k out.mp3</code></pre>
</div>
<div id="lower-video-resolution" class="section level5">
<h5>Lower video resolution</h5>
<p>For example to avoid my tablet to lag.</p>
<pre class="bash"><code>ffmpeg -y -i large.mkv -vf &quot;scale=-1:720&quot; -c:v libx264 -crf 23 smaller.mkv</code></pre>
<ul>
<li>Change <code>720</code> to the desired resolution</li>
<li>Increase the <code>-crf</code> value for smaller file size (and video quality).</li>
</ul>
</div>
</div>
<div id="pdf" class="section level3">
<h3>PDF</h3>
<div id="to-eps" class="section level4">
<h4>to EPS</h4>
<p>I ended up using Inkscape in command-line mode. The result is not so bad (better than the <code>pdf2eps</code> etc).</p>
<pre class="sh"><code>inkscape document.pdf --export-eps=document.eps</code></pre>
<p><a href="http://blm.io/blog/convert-pdf-eps-osx/">Apparently</a>, <code>pdftops</code> is even better.</p>
<pre class="sh"><code>pdftops -eps document.pdf</code></pre>
</div>
<div id="to-pdfa" class="section level4">
<h4>to PDF/A</h4>
<p>In the end I had to use Acrobat Reader Pro…
Still, converting the PDF using the following commands beforehand helped (otherwise Acrobat Reader Pro couldn’t convert it):</p>
<pre class="sh"><code>gs -dPDFA=1 -dBATCH -dNOPAUSE -dEmbedAllFonts=true -dSubsetFonts=false -dHaveTrueTypes=true -dPDFSETTINGS=/prepress -sProcessColorModel=DeviceRGB -sDEVICE=pdfwrite -sPDFACompatibilityPolicy=1 -sOutputFile=mainPDFA.pdf main.pdf</code></pre>
<p>On the other hand, passing by a <code>.ps</code> stage as recommended <a href="https://superuser.com/questions/188953/how-to-convert-a-pdf-to-a-pdf-a">here</a>, produced a smaller PDF that was directly PDF/A compliant (no need for Acrobat Reader Pro) but lost all cross-reference links :(</p>
<pre class="sh"><code>pdftops main.pdf main.ps
gs -dPDFA -dBATCH -dNOPAUSE -dNOOUTERSAVE -dUseCIEColor -sProcessColorModel=DeviceCMYK -sDEVICE=pdfwrite -sPDFACompatibilityPolicy=1 -sOutputFile=mainPDFA.pdf main.ps</code></pre>
<p>To check for PDF/A compliance I used <a href="https://www.pdf-online.com/osa/validate.aspx">this online validator</a> or Acrobat Reader Pro.
Another way to check for problems is to look at the <em>emb</em> column of <code>pdffonts main.pdf</code> (should be all embedded) and the <em>type</em> column of <code>pdfimages -list main.pdf</code> (should be all <em>image</em>).</p>
<p><em>Note: this is based only on my one-time experience with the PDF of my thesis.</em></p>
</div>
<div id="adding-a-signature-to-a-pdf" class="section level4">
<h4>Adding a signature to a PDF</h4>
<p>On Ubuntu, I digitally add signatures using <a href="http://xournal.sourceforge.net/">Xournal</a>.
It’s ugly but the output PDF is left unchanged and it’s easy to place the signature (from a .png file for example) and export to PDF.</p>
</div>
<div id="remove-watermark" class="section level4">
<h4>Remove watermark</h4>
<p>Some articles have diagonal watermarks behind the text.
It makes it more difficult to select and copy text.
Personally, it’s annoying when I want to highlight/annotate a PDF.</p>
<p>Sometimes it’s as easy as uncompressing the PDF and replacing the text of the watermark.
From <a href="https://superuser.com/questions/448519/how-to-remove-watermark-from-pdf-using-pdftk">StackExchange</a>:</p>
<pre><code>pdftk original.pdf output uncompressed.pdf uncompress 
sed -e &quot;s/watermarktextstring/ /&quot; uncompressed.pdf &gt; unwatermarked.pdf
pdftk unwatermarked.pdf output fixed.pdf compress</code></pre>
<p>Sometimes, the watermark text is not there in the PDF (e.g. the letters are split or the font uses unicodes or something).
That’s my experience with Nature papers with the annoyingly big “ACCELERATED ARTICLE PREVIEW” watermark.
In this situation, I had to look at the uncompress PDF (e.g. <code>cat uncompress.pdf | less</code>) to guess the block with the watermark and then mess it up (e.g. its text matrix field Tm):</p>
<pre><code>sed -e &quot;s/33.94110107 33.94110107 -33.94110107 33.94110107 5.8685999 122.48609924 Tm/0 0 0 0 0 0 Tm/g&quot; &lt; uncompress.pdf &gt; unwatermarked.pdf</code></pre>
<p>for a block that looked like:</p>
<pre><code>...
BT
0 0 0 rg
/GS2 gs
/C2_1 1 Tf
0 Tc
0 Tw
33.94110107 33.94110107 -33.94110107 33.94110107 5.8685999 122.48609924 Tm
(^@$)Tj
.695 0 Td
(^@&amp;)Tj
.722 0 Td
(^@&amp;)Tj
.695 0 Td
(^@\()Tj
.61199998 0 Td
(^@/)Tj
.61199998 0 Td
(^@\()Tj
.695 0 Td
(^@5)Tj
.695 0 Td
(^@$)Tj
.639 0 Td
(^@7)Tj
.639 0 Td
(^@\()Tj
.695 0 Td
(^@&#39;)Tj
.361 -.85799998 Td
(^@^C)Tj
...</code></pre>
</div>
</div>
</div>
